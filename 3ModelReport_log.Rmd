---
title: "ModelReportAll"
author: "Xiuna Zhu"
date: "12/6/2020"
output:
  html_document:
    df_print: paged
    number_sections: true
  pdf_document: 
    number_sections: true
---
```{r setup,}
knitr::opts_chunk$set(echo = TRUE)
```

# Load the packages {-}

```{r message=FALSE, warning=FALSE}
library(reshape2)
library(latex2exp)
library(rlist)
library(bayesplot)
source('ana_functions.R') 
source('mytheme.R') 
modellist <- c('LGM','DIM', 'PIM')# IP #'BPM' #'Baseline' 
logVersion = 'log'
rstanmodelPath = 'RSTANMODELS'
modelPath = paste0('RSTANMODELS/models/', logVersion)
AllExpData <- read.csv(paste0("data/AllExpData_valid.csv"))
```



# Baseline model results (for BR condition)

## load baseline model results

```{r}
#load the parameters from baseline model by fitting BR data 
All_PredY_BR= read.csv(paste0(getwd(), "/RSTANMODELS/models/Baseline_log/All_PredY_BR.csv")) 
All_PredY_BR$model = 'Baseline'
All_PredY_BR$X = NULL
All_PredY_BR1 = All_PredY_BR
All_PredY_BR1$wp = NULL
All_PredY_BR_col= colnames(All_PredY_BR1)
```

```{r include=FALSE}
# check if there is any outliers in parameters
AllDat_Bayparlist_BR <- read_csv("RSTANMODELS/models/Baseline_log/AllDat_Bayparlist_BR.csv")
#convert log scale to linear scale
AllDat_Bayparlist_BR$mu_p_s = exp(AllDat_Bayparlist_BR$mu_p_s_log + AllDat_Bayparlist_BR$sig_pr2_s_log^2*0.5)
AllDat_Bayparlist_BR$sig_pr2_s = (exp(AllDat_Bayparlist_BR$sig_pr2_s_log^2)-1)*exp(2*AllDat_Bayparlist_BR$mu_p_s_log+AllDat_Bayparlist_BR$sig_pr2_s_log^2)

AllDat_Bayparlist_BR$mu_p_l = exp(AllDat_Bayparlist_BR$mu_p_l_log + AllDat_Bayparlist_BR$sig_pr2_l_log^2*0.5)
AllDat_Bayparlist_BR$sig_pr2_l = (exp(AllDat_Bayparlist_BR$sig_pr2_l_log^2)-1)*exp(2*AllDat_Bayparlist_BR$mu_p_l_log+AllDat_Bayparlist_BR$sig_pr2_l_log^2)
```


```{r}
m_parameter_BR = All_PredY_BR %>% dplyr::group_by(targetDur, Exp, group) %>%
  dplyr::summarise(mRP = mean(RP),  n= n(), m_wp = mean(wp), m_mu_r = mean(mu_r), m_sig_r = sd(sig_r), sd_RP = sd(RP),  sd_wp = sd(wp),  sd_mu_r = sd(mu_r), sd_sig_r = sd(sig_r))
```


```{r}
m_parameter_BR_sub = All_PredY_BR %>% dplyr::group_by(NSub, Exp, group) %>%
  dplyr::summarise(mRP = mean(RP),  n= n(), m_wp = mean(wp), m_mu_r = mean(mu_r), m_sig_r = sd(sig_r), sd_RP = sd(RP),  sd_wp = sd(wp),  sd_mu_r = sd(mu_r), sd_sig_r = sd(sig_r))

mm_parameter_BR = All_PredY_BR %>% dplyr::group_by(Exp, group) %>%
  dplyr::summarise(mRP = mean(RP),  n= n(), m_wp = mean(wp), m_mu_r = mean(mu_r), m_sig_r = sd(sig_r), sd_RP = sd(RP),  sd_wp = sd(wp),  sd_mu_r = sd(mu_r), sd_sig_r = sd(sig_r))
```


# Predicted reproduction

```{r message=FALSE, warning=FALSE}
#load prediction generated by models
All_predY = read.csv(paste0(getwd(), "/", modelPath, "/rlt/PredY_mix_list_", logVersion, ".csv"))
All_predY$rpErr = All_predY$mu_r - All_predY$RP
All_predY$rErr = All_predY$rpErr / All_predY$targetDur
All_predY$model <- as.factor(All_predY$model)
All_predY$RP_BIAS = All_predY$RP- All_predY$targetDur
All_predY$prederr = All_predY$mu_r - All_predY$RP #prediction error
All_predY$predBIAS = All_predY$mu_r- All_predY$targetDur
All_predY[which(All_predY$group %in% c('short', 'long')),"priortype"] = 'BR'
All_predY[which(All_predY$group == 'mixed'),"priortype"] = 'IR'
All_predY$priortype = as.factor(All_predY$priortype)
All_predY$range = 'short'
All_predY[which(All_predY$targetDur > 1),"range"] = 'long'
All_predY$range = as.factor(All_predY$range) 
```


# Compare the mean and sd of estimated and true values
```{r}
m_mean_sd <- dplyr::group_by(All_predY, Exp, targetDur, model, priortype) %>%
  dplyr::summarize( n = n(), 
                    m_RP = mean(RP), #mean of observed RP
                    sd_RP = sd(RP), #observed sd of RP
                    m_sig_r = mean(sig_r),
                    m_mu_r = mean(mu_r),
                    sd_mu_r = sd(mu_r)
  )
m_mean_sd$merr_mu_r <- (m_mean_sd$m_mu_r - m_mean_sd$m_RP)/m_mean_sd$m_RP
m_mean_sd$merr_sig_r <- (m_mean_sd$m_sig_r - m_mean_sd$sd_RP)/m_mean_sd$sd_RP
m_mean_sd
```



```{r}
#listed in manuscript
m_m_mean_sd <- dplyr::group_by(m_mean_sd%>%filter(priortype == 'IR'), Exp, model) %>%
  dplyr::summarize( n = n(), 
                    m_sd_rerr = mean(abs(merr_sig_r)),
                    m_merr_mu_r = mean(abs(merr_mu_r))) 
m_m_mean_sd  
```


# Prediction results

```{r, message=FALSE, warning=FALSE, include=FALSE}
predY <- group_by(All_predY, targetDur, Exp, NSub, model, priortype, range) %>%
  dplyr::summarize(m_RP = mean(RP), 
                   m_RP_BIAS = mean(RP_BIAS),
                   m_predBIAS = mean(predBIAS),
                   m_predNBIAS = mean(abs(predBIAS)),
                   m_prederr = mean(prederr),
                   n = n(), 
                   sd_RP = sd(RP),
                   cv_observed = sd_RP/m_RP,
                   se_RP = sd_RP/ sqrt(n-1),
                   m_mu_r = mean(mu_r),
                   m_sig_r = mean(sig_r), # sd of prediction
                   cv_Pred = m_sig_r/m_mu_r)

gp_var <- c('targetDur', 'Exp', 'model', 'priortype', 'range')
m_predY <- summarizePredY(predY, gp_var)

gp_var_sub <- c('NSub', 'Exp', 'model', 'priortype', 'range')
m_predY_sub <- summarizePredY(predY, gp_var_sub)
```


## plot observed RP vs. predicted RP

```{r}
# plot observed RP vs. predicted RP
fig_predRP1_IR =  ggplot(m_predY, aes(targetDur, mm_mu_r, group = interaction(priortype, range), color = model))+
  geom_point(alpha = 0.5)+ 
  geom_point(m_predY, mapping =aes(targetDur, m_m_RP, color = as.factor('observation')))+
  geom_abline(slope = 1, linetype = 2, size = 0.5) + # add diagonal line
  theme_minimal()+ theme_new+ 
  theme(strip.background = element_blank()) + # remove subtitle background
  labs(x = "target duration", y = "predicted Reproduction")+ 
  theme(legend.position = "top")+
  scale_x_continuous(trans='log10') +
  scale_y_continuous(trans='log10')+
  facet_wrap(~Exp)

fig_predRP1_IR
ggsave(file.path(modelPath,'figures/fig_predRP1_IR.png'), fig_predRP1_IR, width = 7, height = 4)
```


```{r}
#average data cross target duration
mm_predY<- m_predY %>%
  dplyr::group_by(Exp, model, priortype, range) %>%
  dplyr::summarize(
    mm_prederr = mean(m_m_prederr),
    mm_RP = mean(m_m_RP),
    m_mm_mu_r =mean(mm_mu_r),
    m_cv_observed = mean(m_cv_observed),
    m_cv_Pred = mean(m_cv_Pred),
    mm_sd_RP = mean(m_sd_RP),
    m_mm_sig_r = mean(mm_sig_r))

mm_predY
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
# prepare the data to draw circles
rmax = 0.15
rmin = 0.0
theta=seq(from=0,by=.01,to=2*pi)
ncirc=12
dat.circ = do.call(rbind,
                   lapply(seq_len(ncirc), function(n){
                     r <- n*rmax/ncirc
                     data.frame(m_m_RP_BIAS=r*sin(theta),
                                mm_sig_r = r*sin(theta),
                                m_m_predBIAS = r*sin(theta),
                                m_cv_Pred=r*cos(theta), r=round(r,2)) 
                   }))
dat.circ1 = dat.circ 
dat.circ2 = dat.circ1
dat.circ1$model = 'PIM'
dat.circ1$Exp = 'Exp1'
dat.circ1$priortype = 'mixed'
dat.circ1$range = 'short'
dat.circ2$range = 'short'
dat.circ2$priortype = 'mixed'
dat.circ2$model = 'PIM'
dat.circ2$Exp = 'Exp2'
dat.circ = rbind(dat.circ1,  dat.circ2)
```




```{r}
mmm_predY <- m_predY_sub %>% dplyr::group_by(Exp, model, priortype) %>%
  dplyr::summarize(
    mm_cv_observed = mean(m_cv_observed),
    mm_cv_Pred = mean(m_cv_Pred), n = n())

mmm_predY$acc_predCV = mmm_predY$mm_cv_Pred /mmm_predY$mm_cv_observed
mmm_predY
```



# Analysis on the Rstan model parameters


## load model parameters and calculate parameters

```{r, message=FALSE, warning=FALSE, include=FALSE}
#generate the path of the results based on model version
modelPath = paste0(rstanmodelPath, '/models/', logVersion)

#load result of Bayesian parameters of all models 
AllDat_Bayparlist <- read.csv(paste0(modelPath,"/rlt/AllDat_Bayparlist_", logVersion, ".csv"))
AllDat_Bayparlist$model <- as.factor(AllDat_Bayparlist$model)
```




## load the model parameter (fitting IR data by log model in two steps)

```{r, message=FALSE, warning=FALSE, include=FALSE}
#generate the path of the results based on model version
log_2part_Version = 'log_2part'
modelPath = paste0(rstanmodelPath, '/models/', log_2part_Version)

#load result of Bayesian parameters of all models 
AllDat_Bayparlist_2part <- read.csv(paste0(modelPath,"/rlt/AllDat_Bayparlist_", log_2part_Version, ".csv"))
AllDat_Bayparlist_2part$model <- as.factor(AllDat_Bayparlist_2part$model)
```


### global prior in linear scale
```{r}
ggboxplot(AllDat_Bayparlist_2part%>%filter(model !='IP'), x = 'model', y = 'mu_p_g', color = 'part', add = 'jitter')+
  facet_wrap(~Exp)+
  scale_color_manual(values = mycolors)
```
```{r}
AllDat_Bayparlist_2part%>%filter(model !='IP') %>% dplyr::group_by(Exp, model, part) %>% 
  dplyr::summarize(m_mu_p_g = mean(mu_p_g), n = n(), se = sd(mu_p_g)/sqrt(n-1)) %>%
  ggplot(aes(model, m_mu_p_g, ymin = m_mu_p_g - se, ymax = m_mu_p_g + se, group = interaction(Exp, model, part), color = part, shape = model))+ 
  geom_line(stat = "identity",position = position_dodge(width = 0.2))+
  geom_point(stat = "identity",position = position_dodge(width = 0.2))+ 
  geom_errorbar(width=.2,  position = position_dodge(width = 0.2)) +
  labs(x = " ", y = "Mean global prior") +
  theme_minimal()+ theme_new + facet_wrap(~Exp)+
  scale_color_manual(values = mycolors)
```

```{r}
ggboxplot(AllDat_Bayparlist_2part%>%filter(model !='IP'), x = 'model', y = 'sig2_p_g', color = 'part', add = 'jitter')+
  facet_wrap(~Exp)+
  scale_color_manual(values = mycolors)
```

```{r}
AllDat_Bayparlist_2part%>%filter(model !='IP') %>% dplyr::group_by(Exp, model, part) %>% 
  dplyr::summarize(m_sig2_p_g = mean(sig2_p_g), n = n(), se = sd(sig2_p_g)/sqrt(n-1)) %>%
  ggplot(aes(model, m_sig2_p_g, ymin = m_sig2_p_g - se, ymax = m_sig2_p_g + se, group = interaction(Exp, model, part), color = part, shape = model))+ 
  geom_line(stat = "identity",position = position_dodge(width = 0.2))+
  geom_point(stat = "identity",position = position_dodge(width = 0.2))+ 
  geom_errorbar(width=.2,  position = position_dodge(width = 0.2)) +
  labs(x = " ", y = "Variance of global prior") +
  theme_minimal()+ theme_new + facet_wrap(~Exp)+
  scale_color_manual(values = mycolors)
```



#  WAIC and LOO-CV

```{r, message=FALSE, warning=FALSE, include=FALSE}
m_WAIC <- dplyr::group_by(AllDat_Bayparlist, Exp, model) %>%
  dplyr::summarize(m_looic = mean(looic),
                   m_p_loo = mean(p_loo),
                   m_elpd_loo = mean(elpd_loo),
                   m_se_looic = mean(se_looic),
                   m_se_p_loo = mean(se_p_loo),
                   m_waic = mean(waic),
                   m_p_waic = mean(p_waic),
                   m_se_waic = mean(se_waic),
                   n = n(),
                   se_waic = sd(waic)/sqrt(n-1),
                   se_looic = sd(looic)/sqrt(n-1)) 
m_WAIC
```


```{r}
dat_WAIC = m_WAIC
dat_WAIC$model <- relevel(dat_WAIC$model, "LGM")
plt_waic <- ggplot(dat_WAIC%>%filter(model !='IP'), aes(model, m_waic, ymin = m_waic - se_waic, ymax = m_waic + se_waic, group =Exp, color = Exp, shape = model))+ 
  geom_line(stat = "identity",position = position_dodge(width = 0.2))+
  geom_point(stat = "identity",position = position_dodge(width = 0.2))+ 
  geom_errorbar(width=.2,  position = position_dodge(width = 0.2)) +
  labs(x = " ", y = "Mean WAIC") +
  theme_minimal()+ theme_new +
  scale_color_manual(values = mycolors)

plt_waic
ggsave(paste0(getwd(), '/', modelPath, '/figures/plt_waic.png'), plt_waic, width = 6, height = 4)
```
```{r, message=FALSE, warning=FALSE, include=FALSE}
plt_looic <- ggplot(dat_WAIC%>%filter(model !='IP'), aes(model, m_looic, ymin = m_looic - se_looic, ymax = m_looic + se_looic,
                                  group =Exp, color = Exp, shape = model))+ 
  geom_line(stat = "identity",position = position_dodge(width = 0.2))+
  geom_point(stat = "identity",position = position_dodge(width = 0.2))+ 
  geom_errorbar(width=.2,  position = position_dodge(width = 0.2)) +
  labs(x = " ", y = "Mean LOOIC") +
  theme_minimal()+ theme_new +
  scale_color_manual(values = mycolors)

ggsave(paste0(getwd(), '/', modelPath, '/figures/plt_looic.png'), plt_looic, width = 4, height = 4)
plt_looic
```

```{r}
library(ggpubr)
fig_waic_looic<- ggarrange(plt_waic, plt_looic, common.legend = TRUE, legend = "bottom")

ggsave(paste0(getwd(), '/', modelPath, '/figures/fig_waic_looic.png'), fig_waic_looic, width = 7, height = 4)
fig_waic_looic
```


## Parameters in all models

```{r}
m_Baypar <- dplyr::group_by(AllDat_Bayparlist, Nsub, Exp, model) %>%
    dplyr::summarize(m_mu_p_g = mean(mu_p_g),
                   m_sig2_p_g = mean(sig2_p_g),
                   m_mu_p_s_IR = mean(mu_p_s_IR),
                   m_mu_p_l_IR = mean(mu_p_l_IR),
                   m_sig2_p_g = mean(sig_pr2_s_IR),
                   m_sig_pr2_l_IR = mean(sig_pr2_l_IR)) 

m_Baypar

write.csv(m_Baypar, paste0(modelPath,"/rlt/m_Baypar_", logVersion, ".csv") )
```





```{r}
mm_Baypar <- dplyr::group_by(m_Baypar, Exp, model) %>%
  dplyr::summarize( mm_mu_p_s = mean(m_mu_p_s_IR), 
                    mm_mu_p_l = mean(m_mu_p_l_IR), 
                    mm_mu_p_g = mean(m_mu_p_g), 
                    mm_sig2_p_s = mean(m_mu_p_s_IR),
                    mm_sig2_p_l = mean(m_sig_pr2_l_IR),
                    mm_sig2_p_g = mean(m_sig2_p_g))

mm_Baypar
```




```{r}
fig_sigma2_long <- ggplot(mm_Baypar, aes(Exp, mm_sig_pr2_l, ymin = mm_sig_pr2_l -se_sig_pr2_l , ymax = mm_sig_pr2_l + se_sig_pr2_l, group = model, color = model), shape = model)+ 
  geom_line(stat = "identity",position = position_dodge(width = 0.2))+
  geom_point(stat = "identity",position = position_dodge(width = 0.2))+ 
  geom_errorbar(width=.2,  position = position_dodge(width = 0.2)) +
  theme_minimal()+ theme_new +
  labs(x = " ",
       y = "variance of local prior for long range",
       color = "model")+
  #scale_color_manual(values = mycolors5) +
  scale_shape_manual(values = myshapevalues)
```






## Observed and predicted Reproduction Error 

```{r message=FALSE, warning=FALSE}
fig_mrepError_model <- ggplot(m_predY%>%filter(priortype == 'IR', model != 'IP'),
                              aes(targetDur, 
                                  mm_mu_r-m_m_RP, ymin = m_m_prederr - se_prederr, ymax = m_m_prederr + se_prederr,
                                  group = interaction(range, model), color = model)) + 
  geom_point(position = position_dodge(width = 0.05))+
  geom_errorbar(width = .05, position = position_dodge(width = 0.05))+
  geom_line(size = .5, aes(color = model, linetype = model),  position = position_dodge(width = 0.05))+
  #geom_point(data = sumexp%>%filter(priortype == 'IR'),  aes(targetDur, m_m_RP-m_m_RP, color = model))+ # measurement data
  geom_hline(yintercept= 0, linetype = 2) +
  theme_minimal()+ theme_new + 
  #scale_color_manual(values = mycolors5) +
  scale_linetype_manual(values =  c('solid','dotted','dashed' ))+
  facet_wrap(~Exp)+
  scale_linetype(guide = FALSE)+
  theme(strip.background = element_blank()) + # remove subtitle background
  labs(x = 'Intervals (s)', y = 'Model predicted error(s)',  color='model')+ theme(legend.position='bottom')+
  scale_x_continuous(trans='log10') +colorSet3


ggsave(file.path(modelPath,'figures/fig_mrepError_model.png'), fig_mrepError_model, width = 7, height = 4)
fig_mrepError_model
```

```{r}
# observed data
exps <- read.csv(paste0(getwd(), '/data/AllExpData_valid.csv'))
gp_var_prior= c("NSub", "targetDur", "Exp", "priortype", "range")
sumexp <- summarizeMeanData(exps, gp_var_prior)
sumexp$model = as.factor('measured')
```


```{r}
#m_m_RP se_prederr
fig_modelPrediction <- ggplot(m_predY%>%filter(priortype == 'IR', model != 'IP'),
                              aes(targetDur, 
                                  mm_mu_r, ymin = mm_mu_r+mm_sig_r, ymax = mm_mu_r-mm_sig_r,
                                  group = interaction(range, model), color = model)) + 
  geom_point(position = position_dodge(width = 0.05))+
  geom_errorbar(width = .05, position = position_dodge(width = 0.05))+
  geom_line(size = .5, aes(color = model, linetype = model),  position = position_dodge(width = 0.05))+
  geom_point(data = sumexp%>%filter(priortype == 'IR'),  aes(targetDur, m_m_RP, ymin = m_m_RP+m_sd_RP, ymax = m_m_RP-m_sd_RP, color = model))+ # measurement data
  theme_minimal()+ theme_new + 
  #scale_color_manual(values = mycolors5) +
  #scale_linetype_manual(values =  c('solid','dotted','dashed' ))+
  facet_wrap(~Exp)+
  scale_linetype(guide = FALSE)+
  theme(strip.background = element_blank()) + # remove subtitle background
  labs(x = 'Intervals (s)', y = 'Predicted reproduction (s)',  color='model')+ theme(legend.position='bottom')+
  scale_x_continuous(trans='log10') +colorSet4


ggsave(file.path(modelPath,'figures/fig_modelPrediction.png'), fig_modelPrediction, width = 7, height = 4)
fig_modelPrediction
```



```{r}
predY_err <- m_predY_sub %>%dplyr::group_by(Exp, model,range, priortype) %>%
  dplyr::summarize(n= n(),
                   mm_pred_Var = mean(mm_sig_r- m_sd_RP),
                   se_prederr = sd(m_m_prederr)/sqrt(n-1),
                   se_pred_Var = sd(mm_sig_r- m_sd_RP)/sqrt(n-1),
                   m_m_prederr = mean(m_m_prederr))
predY_err$m_m_prederr=0
```

```{r}
m_predY_sub$mm_pred_Var = m_predY_sub$mm_sig_r- m_predY_sub$m_sd_RP
plt_rErrorScatter = ggplot(data = predY_err%>%filter(priortype == 'IR', model != 'IP'), aes(m_m_prederr, mm_pred_Var, color = model, shape=range)) +  
  geom_hline(yintercept = 0, linetype='dashed')+ geom_vline(xintercept = 0, linetype='dashed')+ 
  geom_point(alpha = .5, size = 4)+
  geom_errorbar(aes(ymin = mm_pred_Var-se_pred_Var, ymax = mm_pred_Var+se_pred_Var), width = .01)+
  geom_errorbarh(aes(xmin=m_m_prederr-se_prederr, xmax = m_m_prederr+se_prederr), width = .01)+
  geom_point(data = m_predY_sub%>%filter(priortype == 'IR', model != 'IP'), aes(m_m_prederr, mm_pred_Var, color = model, shape=range), alpha = 0.9, size = 1) +
  xlab('Prediction error in the RP mean')+ 
  ylab('Prediction error in the RP variance')+
  facet_wrap(~Exp)+colorSet3+
  theme_new+ theme(legend.position = 'top')

plt_rErrorScatter
```


```{r}
predY_err_new <- m_predY_sub %>%dplyr::group_by(Exp, model, priortype) %>%
  dplyr::summarize(n= n(),
                   mm_m_RP = mean(m_m_RP),
                   mm_sd_RP = mean(m_sd_RP),
                   mm_pred_Var = mean(mm_sig_r- m_sd_RP),
                   mm_pred_Var_NBIAS = mean(abs(mm_sig_r- m_sd_RP)),
                   se_prederr = sd(m_m_prederr)/sqrt(n-1),
                   se_pred_Var = sd(mm_sig_r- m_sd_RP)/sqrt(n-1), 
                   m_m_prederr = mean(m_m_prederr),
                   m_m_pred_NBIAS = mean(abs(m_m_prederr)))
```


```{r}
gp_var_sub <- c('NSub', 'Exp', 'model', 'priortype')
m_predY_sub_new <- summarizePredY(predY, gp_var_sub)
m_predY_sub_new$mm_pred_Var = m_predY_sub_new$mm_sig_r- m_predY_sub_new$m_sd_RP
plt_rErrorScatter1 = ggplot(data = predY_err_new%>%filter(priortype == 'IR', model !='IP'), aes(m_m_prederr, mm_pred_Var, color = model)) +  
  geom_hline(yintercept = 0, linetype='dashed')+ geom_vline(xintercept = 0, linetype='dashed')+ 
  geom_point(alpha = .5, size = 4)+
  geom_errorbar(aes(ymin = mm_pred_Var-se_pred_Var, ymax = mm_pred_Var+se_pred_Var), width = .005)+
  geom_errorbarh(aes(xmin=m_m_prederr-se_prederr, xmax = m_m_prederr+se_prederr), width = .1)+
  geom_point(m_predY_sub_new%>%filter(priortype == 'IR', model != 'IP'), mapping = aes(m_m_prederr, mm_pred_Var, color = model), alpha = .9) +  
  facet_wrap(~Exp) +colorSet3+
  xlab('Prediction error in the RP mean')+ 
  ylab('Prediction error in the RP variance')+
  theme_new+ theme(legend.position = 'top')+guides(size="none")+guides(alpha="none")
plt_rErrorScatter1
```

```{r}
plt_rErrorScatter2 = ggplot(data = predY_err_new%>%filter(priortype == 'IR', model !='IP'), aes(m_m_pred_NBIAS, mm_pred_Var_NBIAS, color = model)) +  
  #geom_hline(yintercept = 0, linetype='dashed')+ geom_vline(xintercept = 0, linetype='dashed')+ 
  geom_point(alpha = .5, size = 4)+
  geom_errorbar(aes(ymin = mm_pred_Var_NBIAS-se_prederr, ymax = mm_pred_Var_NBIAS+se_prederr), width = .005)+
  geom_errorbarh(aes(xmin= m_m_pred_NBIAS-se_pred_Var, xmax = m_m_pred_NBIAS+se_pred_Var), height = .01)+
  geom_point(m_predY_sub_new%>%filter(priortype == 'IR', model != 'IP'), mapping = aes(abs(m_m_prederr), abs(mm_pred_Var), color = model), alpha = .9) +  
  facet_wrap(~Exp) +colorSet3+
  xlab('Mean absolute error of reproduction mean')+  
  ylab('Mean absolute error of reproduction variance')+
  theme_new+ theme(legend.position = 'top')+guides(size="none")+guides(alpha="none")
plt_rErrorScatter2
```

```{r}
predY_err_new$acc_err <-   100*(1-predY_err_new$m_m_pred_NBIAS/predY_err_new$mm_m_RP)
predY_err_new$acc_var <- 100*(1-predY_err_new$mm_pred_Var_NBIAS/predY_err_new$mm_sd_RP)
```


```{r}
plt_rErrorScatter3 = ggplot(data = predY_err_new%>%filter(priortype == 'IR', model !='IP'), aes(100*m_m_pred_NBIAS/mm_m_RP, 100*mm_pred_Var_NBIAS/mm_sd_RP, color = model)) +  
  #geom_hline(yintercept = 0, linetype='dashed')+ geom_vline(xintercept = 0, linetype='dashed')+ 
  geom_point(alpha = .5, size = 5)+
  geom_errorbar(aes(ymin = 100*(mm_pred_Var_NBIAS-se_prederr)/mm_sd_RP, ymax = 100*(mm_pred_Var_NBIAS+se_prederr)/mm_sd_RP), width = .2)+
  geom_errorbarh(aes(xmin= 100*(m_m_pred_NBIAS-se_pred_Var)/mm_m_RP, xmax = 100*(m_m_pred_NBIAS+se_pred_Var)/mm_m_RP), height = 2)+
  geom_point(m_predY_sub_new%>%filter(priortype == 'IR', model != 'IP'), mapping = aes(100*abs(m_m_prederr)/m_m_RP, 100*abs(mm_pred_Var)/m_sd_RP, color = model), alpha = .5) +  
  facet_wrap(~Exp) +colorSet3+
  xlab('MAPE of Reproduction mean(%)')+ 
  ylab('MAPE of Reproduction variance(%)')+
  theme_new+ theme(legend.position = 'top')+guides(size="none")+guides(alpha="none")
plt_rErrorScatter3
```

```{r}
fig_ModelRlt <- ggarrange(fig_mrepError_model, plt_rErrorScatter3, common.legend = TRUE, nrow = 2, ncol = 1, labels = c('a', 'b'))
ggsave(paste0(getwd(), "/", modelPath, "/figures/fig_ModelRlt.png"), fig_ModelRlt, width = 7, height = 7)
fig_ModelRlt
```

## Compute correlation

```{r}
cor_err_table <- predY %>% dplyr::group_by(Exp, model) %>%
  dplyr::summarise(r2 = cor(m_RP, m_mu_r, method = c("pearson", "kendall", "spearman")))%>% dplyr::group_by(Exp, model) %>%
  dplyr::summarise(m_r2 = mean(r2))
cor_err_table
```

```{r}
cor_err_table <- predY%>% filter(priortype =='IR', model != 'Baseline') %>% dplyr::group_by(Exp, model) %>%
  dplyr::summarise(r2 = cor(m_RP, m_mu_r, method = c("pearson", "kendall", "spearman")))%>% dplyr::group_by(Exp, model) %>%
  dplyr::summarise(m_r2 = mean(r2))
cor_err_table
```


```{r}
cor_err_table_DIM <- predY%>% filter(priortype =='IR', model == 'DIM') %>% dplyr::group_by(Exp, model, range) %>%
  dplyr::summarise(r2 = cor(m_RP, m_mu_r, method = c("pearson", "kendall", "spearman")))%>% dplyr::group_by(Exp, model, range) %>%
  dplyr::summarise(m_r2 = mean(r2))
cor_err_table_DIM
```


# mean of global prior

```{r}
AllDat_Bayparlist %>%
  group_by(model,Exp) %>%
  summarise(m_mu_p_g = mean(mu_p_g), n=n(), se = sd(mu_p_g)/sqrt(n-1)) %>% ggplot(aes(model, m_mu_p_g, color = model)) + geom_line()+ geom_point() + geom_errorbar(aes(ymin = m_mu_p_g - se, ymax = m_mu_p_g + se ), width = 1) +
  xlab('models') + ylab('mean of global prior') +
  facet_grid(~Exp)+ theme_new
```




# Weights of global prior

```{r}
select_colnames = c("NSub", "targetDur", "model", "Exp", "W_Ds", "W_P_G", "W_L", "W_P_S", "W_P_L", "part")
PredY_mixed_dat = NULL
for(modelname in modellist){
  PredYdat <- read.csv(paste0(getwd(), "/", modelPath, "/rlt/PredY_", modelname, ".csv")) %>%select(select_colnames)
  PredY_mixed_dat = rbind(PredY_mixed_dat, PredYdat)
}
PredY_mixed_dat[which(PredY_mixed_dat$targetDur <= 1),"range"] = 'short'
PredY_mixed_dat[which(PredY_mixed_dat$targetDur >= 1),"range"] = 'long'
PredY_mixed_dat$range = as.factor(PredY_mixed_dat$range)
```


#### check if the sum of weights of Ds, PG, PL is equals to 1
```{r}
PredY_mixed_dat$total = PredY_mixed_dat$W_Ds + PredY_mixed_dat$W_P_G + PredY_mixed_dat$W_L
```




## plot weight of priors
```{r}
mweight = PredY_mixed_dat %>%group_by(targetDur, model, Exp) %>%
  dplyr::summarize(m_W_Ds = mean(W_Ds),
                   m_W_P_G = mean(W_P_G), 
                   m_W_L = mean(W_L), 
                   m_W_P_S = mean(W_P_S),
                   m_W_P_L = mean(W_P_L),
                   n = n(),
                   se_W_Ds= sd(W_Ds)/sqrt(n-1),
                   se_W_P_G = sd(W_P_G)/sqrt(n-1),
                   se_W_L = sd(W_L)/sqrt(n-1),
                   se_W_P_S = sd(W_P_S)/sqrt(n-1),
                   se_W_P_L = sd(W_P_L)/sqrt(n-1))
```

```{r}
mweight %>% ggplot(aes(targetDur, m_W_Ds, group = interaction(model, Exp), color =model, shape = model)) + geom_line(aes(linetype = model))+ geom_point() + 
  #geom_errorbar(aes(ymin = m_W_Ds - se_W_Ds, ymax = m_W_Ds + se_W_Ds ), width = 1) +
  xlab('models') + ylab('Weight of Ds in estimation') +facet_grid(~Exp)+ theme_new
```
```{r}
mweight %>% ggplot(aes(targetDur, m_W_P_G, group = interaction(model, Exp), color =model, shape = model)) + geom_line(aes(linetype = model))+ geom_point() + 
  #geom_errorbar(aes(ymin = m_W_P_G - se_W_P_G, ymax = m_W_P_G + se_W_P_G ), width = 1) +
  xlab('models') + ylab('Weight of global prior in estimation') +facet_grid(~Exp)+ theme_new
```







# model comparison (logarithmic vs. linear)

```{r include=FALSE}
m_predY_sub <- All_predY%>% filter(model %in% c('DIM','LGM','PIM'))%>%
  dplyr::group_by( targetDur, model, Exp, NSub) %>%
  dplyr::summarize(m_repDur = mean(RP), 
                   n = n(), 
                   sd_repDur = sd(RP),
                   m_mu_r = mean(mu_r), 
                   m_sig_r = mean(sig_r),
                   predRP_err = mean(mu_r-RP),
                   predVar_err = mean(sig_r-sd_repDur),
                   predRP_rerr = mean(abs(mu_r-m_repDur)/m_repDur),
                   predVar_rerr = mean(abs(sig_r-sd_repDur)/sd_repDur),
                   cv = sd_repDur/m_repDur,
                   pred_cv = mean(sig_r/mu_r),
                   predcv_err = pred_cv-cv,
                   predcv_rerr = mean(abs(pred_cv-cv)/cv) )

m_predErr_sub<- m_predY_sub%>%
  dplyr::group_by(Exp, model, NSub) %>% dplyr::summarise(
    mpredRP_err=mean(predRP_err),
    mpredVar_err=mean(predVar_err),
    mpredRP_rerr = mean(predRP_rerr),
    mpredVar_rerr = mean(predVar_rerr),
    mpredcv_rerr = mean(predcv_rerr),
    mpredcv_err = mean(predcv_err))

m_predY <- m_predY_sub %>%
  dplyr::group_by(Exp, targetDur, model) %>% 
  dplyr::summarize(n = n(),
                   m_m_repDur = mean(m_repDur),
                   se_m_repDur = sd(m_repDur) /sqrt(n-1),
                   m_sd_repDur = mean(sd_repDur), 
                   m_m_sig_r =mean(m_sig_r),
                   se_sig_r = sd(m_sig_r)/sqrt(n-1),
                   m_m_mu_r = mean(m_mu_r),
                   cv = mean(cv),
                   pred_cv = mean(pred_cv),
                   mpredRP_err = mean(predRP_err),
                   mpredVar_err = mean(predVar_err),
                   mpredRP_rerr = mean(predRP_rerr),
                   mpredVar_rerr = mean(predVar_rerr), 
                   mpredcv_err = mean(predcv_err),
                   mpredcv_rerr = mean(predcv_rerr))

m_predErr<- m_predY%>% 
  dplyr::group_by(Exp, model) %>% dplyr::summarise(
    mmpredRP_err=mean(mpredRP_err),
    mmpredVar_err=mean(mpredVar_err),
    mmpredRP_rerr = mean(mpredRP_rerr),
    mmpredVar_rerr = mean(mpredVar_rerr),
    mmpredcv_rerr = mean(mpredcv_rerr),
    mmpredcv_err = mean(mpredcv_err))
m_predErr_sub$version = 'logarithmic'
m_predErr$version = 'logarithmic'
write.csv(m_predErr_sub, paste0(getwd(), "/", modelPath, "/rlt/m_predErr_sub_", logVersion, ".csv"))
write.csv(m_predErr, paste0(getwd(), "/", modelPath, "/rlt/m_predErr_", logVersion, ".csv"))
```


```{r}
#import linear model results
linear_model = 'linear'
m_predErr_linear = read.csv(paste0(getwd(), "/", rstanmodelPath, '/models/', linear_model, "/rlt/m_predErr_", linear_model, ".csv"))
m_predErr_linear$X = NULL
m_predErr_sub_linear = read.csv(paste0(getwd(), "/", rstanmodelPath, '/models/', linear_model, "/rlt/m_predErr_sub_", linear_model, ".csv"))
m_predErr_sub_linear$X = NULL

m_predErr_sub_all = rbind(m_predErr_sub, m_predErr_sub_linear) 
m_predErr_all = rbind(m_predErr, m_predErr_linear)
```

```{r}
m_predErr_all$version = as.factor(m_predErr_all$version)
temp = m_predErr_all %>% filter(version == 'logarithmic') %>%summarise(abs_mmpredcv_err = abs(mmpredcv_err)) 

plt_Err_CV_all = ggplot(m_predErr_all%>%filter(model != 'IP'), aes(abs(mmpredRP_err), abs(mmpredcv_err), group = interaction(model, Exp, version), color = model, shape = Exp, size = version)) + 
  geom_point() +
  geom_hline(yintercept = round(max(temp$abs_mmpredcv_err), 4)+0.0005, linetype='dashed')+
  xlab('Prediction error in the RP means (s)')+ ylab('Prediction error in CV')+ colorSet3+
  scale_shape_manual(values = c(6, 7, 16, 17)) +
  theme_new+ 
  theme(legend.position = 'top')+
  labs(size = 'Memory Load')+
  guides(colour = guide_legend(order = 1, nrow=2,byrow=TRUE),
         shape = guide_legend(order =2, nrow=2,byrow=TRUE),
         size = guide_legend(order = 3, nrow=3,byrow=TRUE))

ggsave(paste0(getwd(), "/", modelPath, "/figures/plt_Err_CV_all.png"), plt_Err_CV_all, width = 7, height = 4)

plt_Err_CV_all
```



```{r}
m_predY_acc =  m_predErr_sub_all%>% 
  dplyr::group_by(Exp, model, version) %>% 
  dplyr::summarize(mmpredRP_rerr = mean(mpredRP_rerr)*100,
                   mmpredVar_rerr = mean(mpredVar_rerr)*100,
                   mmpredcv_rerr = mean(mpredcv_rerr)*100,
                   mmpredRP_acc = (1-mean(mpredRP_rerr))*100,
                   mmpredVar_acc = (1-mean(mpredVar_rerr))*100,
                   mmpredCV_acc = (1-mean(mpredcv_rerr))*100)
m_predY_acc
```






