---
title: "ModelReportBaseline"
author: "Fiona Zhu"
date: "18/03/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load the packages
```{r include=FALSE}
library(tidyverse)
library(rstan)
library(readr)
```

customize theme
```{r}
 theme_new <- theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        strip.background = element_rect(color = "white", fill = "white"),
        panel.grid = element_blank())

```

## load all experiment  data

```{r include=FALSE}
AllExpData <- read_csv(paste0("data/AllExpData.csv"))
```


```{r}
options(mc.cores = parallel::detectCores())
rstan_options (auto_write=TRUE)
# flag for saving figures 
saveFigure = TRUE
# flag for generating CSV  
generateSCV = TRUE
# flag for running rstan model and saving the results
runModels = TRUE
# path of model result
rstanmodelPath = 'RSTANMODELS'
modelResultPath = paste0(rstanmodelPath, '/Baseline')
```

## Define the Rstan models and functions to plot

Baseline : models for the short and long groups, and prediction of the RP.

V1: load the parameters generated by model Baseline("a_s", "b_s", "a_l", "b_l", "p_wf")

### Baseline: Model for short and long groups


```{r include=FALSE}
stancodeBaseline <- 'data {
int<lower=0> n_s;  //number of the short group baseline data points
int<lower=0> n_l;  //number of the long group baseline data points
int<lower=0> n_mix;  //number of the mix group baseline data points
real<lower=0> Y_s[n_s];   //measured reproductive duration (short group)
real<lower=0> X_s[n_s];   //stimulus duration (short group)
real<lower=0> Y_l[n_l];   //measured reproductive duration (long group)
real<lower=0> X_l[n_l];   //stimulus duration (long group)
real<lower=0> X_mix[n_mix];   //stimulus duration (mix group)
}

parameters {
//hyperparameters
real<lower=0, upper =1> p_wf;   //Weber Fraction of local prior
real a_s;
real b_s;
real a_l;
real b_l;
}

model {
//hyperpriors
a_s ~ normal(0, 1);  // short group intercept
b_s ~ normal(1, 1);  // short group slope
a_l ~ normal(0, 1);   // long group intercept
b_l ~ normal(1, 1);   // long group slope

//priors


//likelihood
for (i in 1:n_s)
{
  Y_s[i] ~ normal(a_s + b_s * X_s[i], p_wf *X_s[i]); //short groups
}

for (j in 1:n_l)
{
  Y_l[j] ~ normal(a_l + b_l * X_l[j], X_l[j]*p_wf); //long groups
}
}

generated quantities {
  vector[n_s] ynew_s;
  vector[n_l] ynew_l;
  vector[n_mix] ynew_mix;

  for (i in 1:n_s)  //prediction of short group
  {
    ynew_s[i]  = normal_rng(a_s + b_s * X_s[i], p_wf *X_s[i]); //short groups
  }
  
  for (j in 1:n_l)   //prediction of long group
  {
    ynew_l[j] = normal_rng(a_l + b_l * X_l[j], X_l[j]*p_wf); //long groups
  }
  
  for (m in 1:n_mix)   //prediction of mix group
  {
    if(X_mix[m] >= 1) {
      ynew_mix[m] = normal_rng(a_l + b_l * X_mix[m], X_mix[m]*p_wf); //long groups
    }
    else {
      ynew_mix[m]  = normal_rng(a_s + b_s * X_mix[m], p_wf *X_mix[m]); //short groups
    }
   
  }

}
'
# compile models
stanmodeBaseline <- stan_model(model_code = stancodeBaseline, model_name="Baseline")
```

### Definisiton of the function to predicte the parameters of Bayesian by runing Rstan model

```{r include=FALSE}
funFitBaseLineStan <- function(data, rstanModel, filename){
  Bayfit = {}
  Bayparlist = {}
  subList <- unique(data$NSub)
  fitparList = {}
  PredYlist_l = {}
  PredYlist_s = {}
  PredYlist_mix = {}
  expList <- unique(data$Exp)
  
  for (expName in expList) {
    subdata <- data %>% filter(valid > 0 & Exp == expName)
    subList <- unique(data$NSub)
    for (subNo in subList) {
      print(paste0('Start working on Subject No.',subNo, ' in ', expName))
      
      xmean <- data %>% filter(valid > 0 & Exp == expName & NSub == subNo )  %>% dplyr::group_by(group) %>% dplyr::summarise(targetMean =mean(targetDur))
      
      subdata <- data %>% filter(valid > 0  & NSub == subNo & Exp == expName)
      data_s<- subdata %>% filter(group == 1)  # short groups only
      data_l <- subdata %>% filter(group == 2)  # long groups only
      data_mix <- subdata %>% filter(group == 3)  # mixed groups
      PredY_s_list <- data_s[c('NSub','targetDur', 'RP','Exp','group')]
      PredY_l_list <- data_l[c('NSub','targetDur', 'RP','Exp','group')]
      PredY_mix_list <- data_mix[c('NSub','targetDur', 'RP','Exp','group')]
      n_s <- length(data_s$RP)
      n_l <- length(data_l$RP)
      n_mix <- length(data_mix$RP)
      
      stan_data = list(Y_s=data_s$RP, n_s=n_s, X_s = data_s$targetDur,
                       Y_l=data_l$RP, n_l=n_l, X_l = data_l$targetDur, 
                       X_mix = data_mix$targetDur, n_mix = n_mix, "xmean" =xmean$targetMean)  #data passed to stan
      
      # fit models
      subfit <- sampling(rstanModel, stan_data, chains = 4, iter = 2000)
      
      parameters <- c("a_s", "b_s", "a_l", "b_l", "p_wf","ynew_s","ynew_l", "ynew_mix")
      fitpar <- summary(subfit, pars = parameters)$summary

      
      
      list_of_draws <- rstan::extract(subfit, pars = parameters)
      a_s =  mean(list_of_draws$a_s)
      b_s =  mean(list_of_draws$b_s)
      a_l =  mean(list_of_draws$a_l)
      b_l =  mean(list_of_draws$b_l)
      p_wf =  mean(list_of_draws$p_wf)
      
      ynew_s_list <- list_of_draws$ynew_s
      pred_y_s <- {}
      for (n in 1:n_s){
        pred_y_s[n] <-  mean(ynew_s_list[,n] )
      }
      PredY_s_list$predY = pred_y_s
      PredYlist_s <- rbind2(PredYlist_s, PredY_s_list)
      
      pred_y_l <- {}
      ynew_l_list <- list_of_draws$ynew_l
      for (n in 1:n_l){
        pred_y_l[n] <-  mean(ynew_l_list[,n] )
      }
      PredY_l_list$predY = pred_y_l
      PredYlist_l <- rbind2(PredYlist_l, PredY_l_list)
      
      
      pred_y_mix <- {}
      ynew_mix_list <- list_of_draws$ynew_mix
      for (n in 1:n_mix){
        pred_y_mix[n] <-  mean(ynew_mix_list[,n] )
      }
      PredY_mix_list$predY = pred_y_mix
      PredYlist_mix <- rbind2(PredYlist_mix, PredY_mix_list)
       
      Baypar = data.frame(
        Nsub = subNo,
        Exp = expName,
        a_s =  a_s,
        b_s =  b_s,
        a_l =  a_l,
        b_l =  b_l,
        p_wf = p_wf
      )
      Bayparlist <- rbind2(Bayparlist, Baypar)
    }
  }
  write.csv(Bayparlist, file = paste0(modelResultPath, "/BaseLine_parlist_Stan.csv"))
  write.csv(PredYlist_s, file = paste0(modelResultPath, "/PredY_s_", filename,".csv"))
  write.csv(PredYlist_l, file = paste0(modelResultPath, "/PredY_l_", filename,".csv"))
  write.csv(PredYlist_mix, file = paste0(modelResultPath, "/PredY_mix_", filename,".csv"))
  
  return(list("Bayparlist" = Bayparlist))
}

```



### run Baseline RStan Models

```{r include=FALSE}
## generate the Baseline parameters
Bayparlist_Baseline  <- funFitBaseLineStan(AllExpData, stanmodeBaseline,'Baseline')
BaselinePar <- Bayparlist_Baseline$Bayparlist
```

## display the model restults


### load the model result data

```{r include=FALSE}
PredY_l_Baseline <- read_csv(paste0(modelResultPath, "/PredY_l_Baseline.csv"))
PredY_s_Baseline <- read_csv(paste0(modelResultPath, "/PredY_s_Baseline.csv"))
PredY_mix_Baseline <- read_csv(paste0(modelResultPath, "/PredY_mix_Baseline.csv"))
AllDat_Bayparlist <- read_csv("RSTANMODELS/Baseline/BaseLine_parlist_Stan.csv")


PredY_Baseline <- rbind(PredY_l_Baseline, PredY_s_Baseline)
PredY_Baseline <- rbind(PredY_Baseline, PredY_mix_Baseline)
PredY_Baseline$group = factor(PredY_Baseline$group, labels = c("short", "long", "mix"))
```



### Analysis on the Rstan model parameters

```{r}
 # AllDat_Bayparlist$model <- factor(AllDat_Bayparlist$model, labels = c( "Hierarchical local-global model","Dual integration model"))
m_Baypar <- dplyr::group_by(AllDat_Bayparlist, Exp, Nsub) %>%
  dplyr::summarize(m_as = mean(a_s), m_al = mean(a_l),
            m_bs = mean(b_s), m_bl = mean(b_l),
            m_p_wf = mean(p_wf))
m_Baypar
```


###  p_wf in models
```{r}
ggplot(m_Baypar, aes(x = Exp, y = m_as, color = Nsub, fill = Nsub, group = Nsub)) + 
    geom_bar(stat = "identity",
             position = position_dodge()) + theme_new
```

```{r}
ggplot(m_Baypar, aes(x = Exp, y = m_bs, color = Nsub, fill = Nsub, group = Nsub)) + 
    geom_bar(stat = "identity",
             position = position_dodge()) + theme_new
```

```{r}
ggplot(m_Baypar, aes(x = Exp, y = m_al, color = Nsub, fill = Nsub, group = Nsub)) + 
    geom_bar(stat = "identity",
             position = position_dodge())+ 
  theme_new 
```

```{r}
ggplot(m_Baypar, aes(x = Exp, y = m_bl, color = Nsub, fill = Nsub, group = Nsub)) + 
    geom_bar(stat = "identity",
             position = position_dodge()) +
   theme_new
```


```{r}
ggplot(m_Baypar, aes(x = Exp, y = m_p_wf, color = Nsub, fill = Nsub, group = Nsub)) + 
    geom_bar(stat = "identity",
             position = position_dodge()) + 
  theme_new
```

## Prediction results (short blocks and long blocks)

```{r}
predY <- group_by(PredY_Baseline, targetDur, Exp, NSub, group) %>%
  summarize(m_RP = mean(RP), n = n(), sd_RP = sd(RP)/ sqrt(n-1),m_predY = mean(predY), sd_predY = sd(predY)/ sqrt(n-1))
predY$m_rpErr = predY$m_predY - predY$m_RP
predY$m_relativeErr = predY$m_rpErr / predY$targetDur
predY
```




### The predication of short and long blocks

```{r}
#plot Error in predication
  ggplot(data=predY, aes(x= targetDur, y=m_rpErr, group = factor(NSub), color= factor(NSub))) + 
    geom_point()+geom_line()+
    labs(x="target intervals", y="Error (predicted RP minus measured reproduction)")+
  facet_wrap(Exp~group) +
  theme_new
```


```{r}
#plot relative Error for mixed blocks
 fig_rerr_model <-  ggplot(data=predY, aes(x= targetDur, y=m_relativeErr*100, group = factor(NSub), color= factor(NSub))) + 
     geom_point()+ geom_line()+
    labs(x="target intervals", y="relative error (%)")+
  facet_wrap(Exp~group) + 
  theme_new
    
fig_rerr_model
ggsave(file.path('figures','fig_rerr_model.png'), fig_rerr_model, width = 7, height = 5)
```


```{r}
#plot the average of the predicted Y under the mixed condition
fig_mpredY = ggplot(predY) + 
  geom_point(aes(targetDur, m_predY, group = factor(NSub), color = factor(NSub))) + 
  geom_line(aes(targetDur, m_RP, group = factor(NSub), color = factor(NSub)),  size = 1) + 
  #geom_errorbar(aes(ymin = m_m_predY-se_m_predY, ymax = m_m_predY + se_m_predY), width = 0.05) + 
  geom_abline(slope = 1, linetype = 2, size = 1) + # add diagonal line
  facet_wrap(~Exp) +
  guides(color = guide_legend(title = element_blank())) + # remove legend title
  theme_classic() + 
  theme(strip.background = element_blank()) + 
  labs(x = "Durations (secs)", y = "Mean Reproductions (secs)", size =15) + theme(legend.position="bottom")+
  facet_wrap(NSub~.) + theme_new

fig_mpredY


ggsave(file.path('figures','fig_mpredY.png'), fig_mpredY, width = 7, height = 5)
```


```{r}
m_predY <- predY%>%
  group_by(targetDur, Exp, group) %>%
  summarize(
    n = n(),
    m_predY = mean(m_predY),
    m_RP = mean(m_RP)
  )
m_predY$m_rpErr =m_predY$m_predY-m_predY$m_RP
```


```{r}
#plot Error in predication
  ggplot(data=m_predY, aes(x= targetDur, y=m_rpErr, 
                           color = factor(group))) + 
    geom_point()+  facet_wrap(~Exp) +
    labs(x="target intervals", y="Error of predicted RP (secs)")+ theme_new

```


```{r}
#plot the average of the predicted Y under the mixed condition
fig_m_predY = ggplot(m_predY) + 
  geom_point(aes(targetDur, m_predY, group = factor(group), color = factor(group))) + 
  geom_line(aes(targetDur, m_RP, group = factor(group), color = factor(group)),  size = 1) + 
  #geom_errorbar(aes(ymin = m_m_predY-se_m_predY, ymax = m_m_predY + se_m_predY), width = 0.05) + 
  geom_abline(slope = 1, linetype = 2, size = 1) + # add diagonal line
  facet_wrap(~Exp) +
  guides(color = guide_legend(title = element_blank())) + # remove legend title
  theme_classic() + 
  theme(strip.background = element_blank()) + 
  labs(x = "Durations (secs)", y = "Mean Reproductions (secs)", size =15) + theme(legend.position="bottom")+ theme_new
fig_m_predY

```

```{r}
m_predY$rpErr_squared <- m_predY$m_rpErr^2

fig_rpErr_model <- ggplot(m_predY, aes(x = Exp, y = rpErr_squared)) + 
    geom_bar(stat = "identity",
             position = position_dodge()) +
    theme(legend.position="bottom")+
    facet_wrap(~group)+
  theme_new

ggsave(file.path('figures','fig_rpErr_model.png'), fig_rpErr_model, width = 7, height = 5)

fig_rpErr_model
```